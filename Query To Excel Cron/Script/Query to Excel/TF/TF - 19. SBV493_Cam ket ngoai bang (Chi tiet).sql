SELECT CUSTBRCD,
				GRP,
				CUSTSEQ,
				NMLOC,
				REFR,
				LOAI,
				DECODE(GRP,'1','0','2','5','3','20','4','50','5','100'),
				SDUQDOI,
				KQUYQUYDOI,
				GREATEST(0, ROUND(DECODE(SIGN(SDUQDOI-KQUYQUYDOI),-1,0,(SDUQDOI-KQUYQUYDOI))*DECODE(GRP,'1',0,'2',5,'3',20,'4',50,'5',100)/100,0))
FROM
(
	SELECT B.CUSTBRCD,DECODE(NVL(Z.GRP,'1'),'0','1',NVL(Z.GRP,'1')) GRP, B.CUSTSEQ, G.NMLOC,
	            ' ' REFR,
		    B.LOAI,
	            B.SODU SDUQDOI,
		    B.KYQUY KQUYQUYDOI

	FROM
		 (SELECT BRCD CUSTBRCD,
			 CUSTSEQ,
			  NMLOC,
			 '' TRREF,
			 '' TRSEQ,
		          LOAI,
			  SODU,
			  KYQUY
	FROM
	   (
		SELECT 'LC' LOAI ,BRCD, CUSTSEQ, NMLOC,'' TRREF,'' TRSEQ,
		SUM(CS1.EXCROSSCAL(BRCD,'VND',&h_trdt, CCYCD,DECODE(ACCTCD,'925101',OFFBAL, '925201',OFFBAL, '925301', OFFBAL, '925401', OFFBAL, '925501', OFFBAL,
		'925103',OFFBAL, '925203',OFFBAL, '925303', OFFBAL, '925403', OFFBAL, '925503', OFFBAL,
		'925105',OFFBAL, '925205',OFFBAL, '925305', OFFBAL, '925405', OFFBAL, '925505', OFFBAL,
		'928105',OFFBAL, '928205',OFFBAL, '928305', OFFBAL, '928405', OFFBAL, '928505', OFFBAL,
		'922105',OFFBAL, '922205',OFFBAL, '922305', OFFBAL, '922405', OFFBAL, '922505',
		OFFBAL, 0),'01','VND','01')) SODU,
		SUM(DECODE(ACCTCD,'466200',CS1.EXCROSSCAL(BRCD,'VND',&h_trdt, CCYCD, DECODE(CCYCD,'VND',OFFBAL,(0.95*OFFBAL)),'01','VND','01'),0)) KYQUY
		FROM
		(
			SELECT  M.TRDT TRDT, M.BRCD BRCD ,M.CCY CCYCD, M.ACCTCD ACCTCD, M.CUSTSEQ CUSTSEQ, C.NMLOC NMLOC, SUM(NVL(M.TDBAL,0)) OFFBAL
			FROM TBGL_MAST M, TBCM_GENERAL C
			WHERE M.BRCD = C.BRCD(+)
				AND M.CUSTSEQ = C.CUSTSEQ(+)
				AND M.ACCTCD IN ('925101','925201','925301','925401','925501','925103','925203','925303','925403','925503','925105','925205','925305','925405','925505')
				AND M.TRDT = &h_trdt
			GROUP BY M.TRDT, M.BRCD, M.CCY, M.ACCTCD, M.CUSTSEQ, C.NMLOC
			 HAVING SUM(M.TDBAL)>0

			UNION

			SELECT  M.TRDT TRDT, M.BRCD BRCD ,M.CCY CCYCD, M.ACCTCD ACCTCD, M.CUSTSEQ CUSTSEQ, C.NMLOC NMLOC, SUM(NVL(M.TDBAL,0)) NOFFBAL
			FROM TBGL_MAST M, TBCM_GENERAL C
			WHERE M.BRCD = C.BRCD(+)
				AND M.CUSTSEQ = C.CUSTSEQ(+)
				AND M.ACCTCD IN ('928105','928205','928305','928405','928505')
				AND M.TRDT = &h_trdt
			GROUP BY M.TRDT, M.BRCD, M.CCY, M.ACCTCD,  M.CUSTSEQ, C.NMLOC
			 HAVING SUM(M.TDBAL)>0

			UNION

			SELECT  M.TRDT TRDT, M.BRCD BRCD ,M.CCY CCYCD, M.ACCTCD ACCTCD, M.CUSTSEQ CUSTSEQ, C.NMLOC NMLOC, SUM(NVL(M.TDBAL,0)) NOFFBAL
			FROM TBGL_MAST M, TBCM_GENERAL C
			WHERE M.BRCD = C.BRCD(+)
				AND M.CUSTSEQ = C.CUSTSEQ(+)
				AND M.ACCTCD IN ('922105','922205','922305','922405','922505')
				AND M.TRDT = &h_trdt
			GROUP BY M.TRDT, M.BRCD, M.CCY, M.ACCTCD, M.CUSTSEQ, C.NMLOC
			HAVING SUM(M.TDBAL)>0

			UNION

			SELECT M.TRDT TRDT, M.BRCD BRCD ,M.CCY CCYCD, M.ACCTCD ACCTCD, M.CUSTSEQ CUSTSEQ, C.NMLOC NMLOC, SUM(NVL(M.TDBAL,0)) NOFFBAL
			FROM   TBCM_GENERAL C, TBGL_MAST M
			WHERE M.ACCTCD='466200'
					AND M.TRDT = &h_trdt
					AND M.BRCD = C.BRCD(+)
					AND M.CUSTSEQ = C.CUSTSEQ(+)
			GROUP BY M.TRDT, M.BRCD, M.CCY, M.ACCTCD, M.CUSTSEQ, C.NMLOC
			HAVING SUM(M.TDBAL)>0
		)
		GROUP BY BRCD, CUSTSEQ, NMLOC

		UNION ALL

		SELECT 'BL'LOAI, BRCD, CUSTSEQ, NMLOC,'' TRREF,'' TRSEQ,
		SUM(CS1.EXCROSSCAL(BRCD,'VND',&h_trdt, CCYCD, DECODE(ACCTCD,'921101',OFFBAL, '921201',OFFBAL, '921301', OFFBAL, '921401', OFFBAL, '921501',
				OFFBAL , '921103', OFFBAL, '921203', OFFBAL, '921303', OFFBAL, '921403', OFFBAL, '921503',
				OFFBAL , '922101', OFFBAL, '922201', OFFBAL, '922301', OFFBAL, '922401', OFFBAL, '922501',
				OFFBAL , '922103', OFFBAL, '922203', OFFBAL, '922303', OFFBAL, '922403', OFFBAL, '922503',
				OFFBAL , '926101', OFFBAL, '926201', OFFBAL, '926301', OFFBAL, '926401', OFFBAL, '926501',
				OFFBAL , '926103', OFFBAL, '926203', OFFBAL, '926303', OFFBAL, '926403', OFFBAL, '926503',
				OFFBAL , '927101', OFFBAL, '927201', OFFBAL, '927301', OFFBAL, '927401', OFFBAL, '927501',
				OFFBAL , '927103', OFFBAL, '927203', OFFBAL, '927303', OFFBAL, '927403', OFFBAL, '927503',
				OFFBAL , '928101', OFFBAL, '928201', OFFBAL, '928301', OFFBAL, '928401', OFFBAL, '928501',
				OFFBAL , '928103', OFFBAL, '928203', OFFBAL, '928303', OFFBAL, '928403', OFFBAL, '928503',
				OFFBAL, 0),'01','VND','01')) SODU,
		SUM(DECODE(ACCTCD,'466400',CS1.EXCROSSCAL(BRCD,'VND',&h_trdt, CCYCD, DECODE(CCYCD,'VND',OFFBAL,(0.95*OFFBAL)),'01','VND','01'),0)) KYQUY
		FROM
		(
			SELECT  M.TRDT TRDT, M.BRCD BRCD ,M.CCY CCYCD, M.ACCTCD ACCTCD, M.CUSTSEQ CUSTSEQ, C.NMLOC NMLOC, SUM(NVL(M.TDBAL,0)) OFFBAL
			FROM TBGL_MAST M, TBCM_GENERAL C
			WHERE M.BRCD = C.BRCD(+)
				AND M.CUSTSEQ = C.CUSTSEQ(+)
				AND M.ACCTCD IN ('921101','921201','921301','921401','921501','921103','921203','921303','921403','921503')
				AND M.TRDT = &h_trdt
			GROUP BY M.TRDT, M.BRCD, M.CCY, M.ACCTCD, M.CUSTSEQ, C.NMLOC
			 HAVING SUM(M.TDBAL)>0

			UNION

			SELECT  M.TRDT TRDT, M.BRCD BRCD ,M.CCY CCYCD, M.ACCTCD ACCTCD, M.CUSTSEQ CUSTSEQ, C.NMLOC NMLOC, SUM(NVL(M.TDBAL,0)) OFFBAL
			FROM TBGL_MAST M, TBCM_GENERAL C
			WHERE M.BRCD = C.BRCD(+)
				AND M.CUSTSEQ = C.CUSTSEQ(+)
				AND M.ACCTCD IN ('922101','922201','922301','922401','922501','922103','922203','922303','922403','922503')
				AND M.TRDT = &h_trdt
			GROUP BY M.TRDT, M.BRCD, M.CCY, M.ACCTCD, M.CUSTSEQ, C.NMLOC
			 HAVING SUM(M.TDBAL)>0

			UNION

			SELECT  M.TRDT TRDT, M.BRCD BRCD ,M.CCY CCYCD, M.ACCTCD ACCTCD, M.CUSTSEQ CUSTSEQ, C.NMLOC NMLOC, SUM(NVL(M.TDBAL,0)) NOFFBAL
			FROM TBGL_MAST M, TBCM_GENERAL C
			WHERE M.BRCD = C.BRCD(+)
				AND M.CUSTSEQ = C.CUSTSEQ(+)
				AND M.ACCTCD IN ('926101','926201','926301','926401','926501','926103','926203','926303','926403','926503')
				AND M.TRDT = &h_trdt
			GROUP BY M.TRDT, M.BRCD, M.CCY, M.ACCTCD,  M.CUSTSEQ, C.NMLOC
			 HAVING SUM(M.TDBAL)>0

			UNION

			SELECT  M.TRDT TRDT, M.BRCD BRCD ,M.CCY CCYCD, M.ACCTCD ACCTCD, M.CUSTSEQ CUSTSEQ, C.NMLOC NMLOC, SUM(NVL(M.TDBAL,0)) NOFFBAL
			FROM TBGL_MAST M, TBCM_GENERAL C
			WHERE M.BRCD = C.BRCD(+)
				AND M.CUSTSEQ = C.CUSTSEQ(+)
				AND M.ACCTCD IN ('927101','927201','927301','927401','927501','927103','927203','927303','927403','927503')
				AND M.TRDT = &h_trdt
			GROUP BY M.TRDT, M.BRCD, M.CCY, M.ACCTCD,  M.CUSTSEQ, C.NMLOC
			 HAVING SUM(M.TDBAL)>0

			UNION

			SELECT  M.TRDT TRDT, M.BRCD BRCD ,M.CCY CCYCD, M.ACCTCD ACCTCD, M.CUSTSEQ CUSTSEQ, C.NMLOC NMLOC, SUM(NVL(M.TDBAL,0)) NOFFBAL
			FROM TBGL_MAST M, TBCM_GENERAL C
			WHERE M.BRCD = C.BRCD(+)
				AND M.CUSTSEQ = C.CUSTSEQ(+)
				AND M.ACCTCD IN ('928101','928201','928301','928401','928501','928103','928203','928303','928403','928503')
				AND M.TRDT = &h_trdt
			GROUP BY M.TRDT, M.BRCD, M.CCY, M.ACCTCD, M.CUSTSEQ, C.NMLOC
			HAVING SUM(M.TDBAL)>0

			UNION

			SELECT M.TRDT TRDT, M.BRCD BRCD ,M.CCY CCYCD, M.ACCTCD ACCTCD, M.CUSTSEQ CUSTSEQ, C.NMLOC NMLOC, SUM(NVL(M.TDBAL,0)) NOFFBAL
			FROM   TBCM_GENERAL C, TBGL_MAST M
			WHERE M.ACCTCD='466400'
					AND M.TRDT = &h_trdt
					AND M.BRCD = C.BRCD(+)
					AND M.CUSTSEQ = C.CUSTSEQ(+)
			GROUP BY M.TRDT, M.BRCD, M.CCY, M.ACCTCD, M.CUSTSEQ, C.NMLOC
			HAVING SUM(M.TDBAL)>0
		)
		GROUP BY BRCD ,CUSTSEQ, NMLOC
	)
       ) B,
	CM1.TBCM_GENERAL G,
		(
		SELECT CUSTSEQLN,DECODE(MAX(GRP),'0','1',MAX(GRP)) GRP
		FROM LN1.TBLN_SBV493
		WHERE TRDT	= 	&h_trdt
		GROUP BY CUSTSEQLN
		) Z
	WHERE B.CUSTBRCD=G.BRCD(+) AND B.CUSTSEQ=G.CUSTSEQ(+)
		AND B.CUSTSEQ=Z.CUSTSEQLN(+)
		AND NVL(G.CUSTDTLTPCD,'XXX') LIKE '%'
		AND NVL(G.CUSTDTLTPCD,'XXX') NOT LIKE ' '
)
WHERE GRP IN  ('1','2','3','4','5')
ORDER BY CUSTBRCD,GRP,CUSTSEQ ,REFR;
